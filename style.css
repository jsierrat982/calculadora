document.addEventListener('DOMContentLoaded', () => {
    
    // --- Referencias al DOM ---
    const resultsBody = document.getElementById('resultsBody');
    const saveBtn = document.getElementById('saveBtn');
    const resetBtn = document.getElementById('resetBtn');
    const addRowBtn = document.getElementById('addRowBtn');
    const addTopRowBtn = document.getElementById('addTopRowBtn');
    const removeRowBtn = document.getElementById('removeRowBtn');
    const removeTopRowBtn = document.getElementById('removeTopRowBtn');
    const predefinedFileSelect = document.getElementById('predefinedFileSelect');
    const darkModeToggle = document.getElementById('darkModeToggle');
    const toggleIcon = document.getElementById('toggleIcon');
    const html = document.documentElement;

    // --- Datos Base ---
    const defaultInitialValues = [250,500,1000,2000,4000,7500,13000,22000,37000,61500];
    let initialValues = [...defaultInitialValues];
    let positionValues = Array(defaultInitialValues.length).fill(14);

    // --- Datos Predefinidos ---
    const predefinedData = {
        '08-13-0400K': { "initialValues": [250, 500, 1000, 1750, 3000, 4750, 7750, 12000], "positionValues": [12, 13, 13, 13, 13, 13, 13, 13] },
        '08-13-0450K': { "initialValues": [250, 500, 1000, 2000, 3250, 5250, 8750, 13750], "positionValues": [12, 13, 13, 13, 13, 13, 13, 13] },
        '08-13-0500K': { "initialValues": [250, 500, 1000, 2000, 3500, 6000, 9750, 15500], "positionValues": [12, 13, 13, 13, 13, 13, 13, 13] },
        '08-14-0500K': { "initialValues": [250, 500, 1000, 1750, 3000, 5250, 9000, 15000], "positionValues": [12, 14, 14, 14, 14, 14, 14, 14] },
        '08-14-0550K': { "initialValues": [250, 500, 1000, 2000, 3500, 6000, 9750, 16250], "positionValues": [12, 14, 14, 14, 14, 14, 14, 14] },
        '09-13-0600K': { "initialValues": [250, 500, 1000, 1750, 2750, 4500, 7000, 11000, 17500], "positionValues": [12, 13, 13, 13, 13, 13, 13, 13, 13] },
        '08-14-0600K': { "initialValues": [250, 500, 1000, 2000, 3750, 6500, 10750, 18000], "positionValues": [12, 14, 14, 14, 14, 14, 14, 14] },
        '09-13-0640K': { "initialValues": [250, 500, 1000, 1750, 2750, 4750, 7500, 12000, 18750], "positionValues": [12, 13, 13, 13, 13, 13, 13, 13, 13] },
        '09-13-0700K': { "initialValues": [250, 500, 1000, 2000, 3250, 5250, 8500, 13750, 21000], "positionValues": [12, 13, 13, 13, 13, 13, 13, 13, 12] },
        '09-14-0750K': { "initialValues": [250, 500, 1000, 1750, 3000, 5000, 8250, 13750, 21750], "positionValues": [12, 14, 14, 14, 14, 14, 14, 14, 13] },
        '09-14-0800K': { "initialValues": [250, 500, 1000, 1750, 3000, 5000, 8500, 14000, 23250], "positionValues": [12, 14, 14, 14, 14, 14, 14, 14, 14] },
        '09-14-0850K': { "initialValues": [250, 500, 1000, 1750, 3000, 5250, 9000, 15000, 25000], "positionValues": [12, 14, 14, 14, 14, 14, 14, 14, 14] },
        '09-14-0900K': { "initialValues": [250, 500, 1000, 2000, 3500, 5750, 9500, 15750, 26000], "positionValues": [12, 14, 14, 14, 14, 14, 14, 14, 14] },
        '09-14-0950K': { "initialValues": [250, 500, 1000, 2000, 3500, 6000, 10000, 16750, 28000], "positionValues": [12, 14, 14, 14, 14, 14, 14, 14, 14] },
        '09-14-1000M': { "initialValues": [250, 500, 1000, 2000, 3500, 6000, 10500, 17750, 30000], "positionValues": [12, 14, 14, 14, 14, 14, 14, 14, 14] },
        '09-14-1050M': { "initialValues": [250, 500, 1000, 2000, 3750, 6500, 11000, 18500, 31500], "positionValues": [12, 14, 14, 14, 14, 14, 14, 14, 14] },
        '10-13-1100M': { "initialValues": [250, 500, 1000, 1750, 3000, 5000, 8000, 13000, 20500, 32000], "positionValues": [12, 13, 13, 13, 13, 13, 13, 13, 13, 13] },
        '09-14-1200M': { "initialValues": [250, 500, 1000, 2000, 4000, 7250, 12500, 21750, 36500], "positionValues": [12, 14, 14, 14, 14, 14, 14, 14, 14] },
        '10-14-1200M': { "initialValues": [250, 500, 1000, 1750, 3000, 5000, 8250, 13750, 21750, 34250], "positionValues": [12, 14, 14, 14, 14, 14, 14, 14, 13, 13] },
        '10-14-1250M': { "initialValues": [250, 500, 1000, 1750, 2750, 4750, 8000, 13250, 21750, 35250], "positionValues": [12, 14, 14, 14, 14, 14, 14, 14, 14, 14] },
        '10-14-1450M': { "initialValues": [250, 500, 1000, 1750, 3000, 5250, 9000, 15500, 25500, 42000], "positionValues": [12, 14, 14, 14, 14, 14, 14, 14, 14, 14] },
        '10-14-1750M': { "initialValues": [250, 500, 1000, 2000, 3750, 6500, 11000, 18500, 30750, 50750], "positionValues": [12, 14, 14, 14, 14, 14, 14, 14, 14, 14] },
        '10-14-1900M': { "initialValues": [250, 500, 1000, 2000, 4000, 7000, 12000, 20000, 33500, 55500], "positionValues": [12, 14, 14, 14, 14, 14, 14, 14, 14, 14] },
        '10-14-2000M': { "initialValues": [250, 500, 1000, 2000, 4000, 7000, 12500, 21000, 35500, 59000], "positionValues": [12, 14, 14, 14, 14, 14, 14, 14, 14, 14] },
        '11-13-2000M': { "initialValues": [250, 500, 1000, 2000, 3500, 5500, 9000, 14500, 23000, 36500, 58000], "positionValues": [12, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13] },
        '8000_400K_08_13': { "initialValues": [250, 500, 1000, 1750, 3000, 4750, 7500, 11750], "positionValues": [32, 13, 13, 13, 13, 13, 13, 13] },
        '16000_700K_08_14': { "initialValues": [500, 750, 1500, 2500, 4250, 7250, 12250, 20500], "positionValues": [32, 12, 14, 14, 14, 14, 14, 14] },
    };

    // --- Funciones ---
    const formatCurrency = (num) => {
        if (isNaN(num)) return '$0';
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(Math.round(num));
    };

    const calculateAndDisplay = () => {
        const rows = resultsBody.getElementsByTagName('tr');
        let cumulativeInvestment = 0;

        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            // Saltar la fila de 'loading' si existiera
            if (row.id === 'loadingRow' || row.classList.contains('empty-state')) continue;

            const positionInput = row.querySelector('.position-input');
            const initialValueInput = row.querySelector('.initial-value-input');
            
            if (!positionInput || !initialValueInput) continue;

            let position = parseInt(positionInput.value);
            let initialValue = parseFloat(initialValueInput.value);

            // Validación básica
            if (isNaN(position) || position < 1) position = 1;
            if (isNaN(initialValue) || initialValue < 0) initialValue = 0;

            // Guardar valores en arrays (sincronización)
            // Nota: Esto asume que el orden del DOM coincide con los arrays
            if(positionValues[i] !== undefined) positionValues[i] = position;
            if(initialValues[i] !== undefined) initialValues[i] = initialValue;

            const charge = initialValue * position;
            cumulativeInvestment += charge;
            const payment = initialValue * 36;
            const profit = payment - cumulativeInvestment;

            row.querySelector('.charge-cell').textContent = formatCurrency(charge);
            row.querySelector('.investment-cell').textContent = formatCurrency(cumulativeInvestment);
            row.querySelector('.payment-cell').textContent = formatCurrency(payment);
            
            const profitCell = row.querySelector('.profit-cell');
            profitCell.textContent = formatCurrency(profit);
            
            // Clases de color
            profitCell.classList.remove('profit-positive', 'profit-negative');
            profitCell.classList.add(profit >= 0 ? 'profit-positive' : 'profit-negative');
        }
    };

    const generateRows = () => {
        let htmlContent = '';

        if (initialValues.length < 1) {
            resultsBody.innerHTML = `<tr class="empty-state"><td colspan="7" class="p-4 text-center">No hay datos. Añade una fila.</td></tr>`;
            return;
        }

        for (let i = 0; i < initialValues.length; i++) {
            htmlContent += `
                <tr class="table-row-hover text-sm border-b border-gray-100 dark:border-gray-700">
                    <td class="p-3 text-center text-gray-500">${i + 1}</td>
                    <td class="p-3">
                        <input type="number" class="w-16 px-2 py-1 custom-input position-input text-center" value="${positionValues[i]}" min="1" max="36">
                    </td>
                    <td class="p-3">
                        <div class="relative flex items-center">
                            <span class="absolute left-2 text-gray-400">$</span>
                            <input type="number" step="250" class="w-28 pl-6 pr-2 py-1 custom-input initial-value-input" value="${initialValues[i]}">
                        </div>
                    </td>
                    <td class="p-3 charge-cell font-medium"></td>
                    <td class="p-3 investment-cell text-gray-600 dark:text-gray-400"></td>
                    <td class="p-3 payment-cell font-medium text-blue-600 dark:text-blue-400"></td>
                    <td class="p-3 profit-cell"></td>
                </tr>
            `;
        }
        
        resultsBody.innerHTML = htmlContent;
        calculateAndDisplay();
    };

    // --- Event Listeners ---

    // Evento delegado para inputs (mejor rendimiento)
    resultsBody.addEventListener('input', (e) => {
        if (e.target.classList.contains('position-input') || e.target.classList.contains('initial-value-input')) {
            calculateAndDisplay();
        }
    });

    // Botones de control
    if(resetBtn) resetBtn.addEventListener('click', () => {
        initialValues = [...defaultInitialValues];
        positionValues = Array(defaultInitialValues.length).fill(14);
        generateRows();
    });

    if(addRowBtn) addRowBtn.addEventListener('click', () => {
        const lastVal = initialValues.length > 0 ? initialValues[initialValues.length - 1] : defaultInitialValues[0];
        initialValues.push(lastVal * 2);
        positionValues.push(14);
        generateRows();
    });

    if(addTopRowBtn) addTopRowBtn.addEventListener('click', () => {
        const firstVal = initialValues.length > 0 ? initialValues[0] : defaultInitialValues[0];
        initialValues.unshift(Math.max(50, Math.round(firstVal / 2)));
        positionValues.unshift(14);
        generateRows();
    });

    if(removeRowBtn) removeRowBtn.addEventListener('click', () => {
        if (initialValues.length > 0) {
            initialValues.pop();
            positionValues.pop();
            generateRows();
        }
    });

    if(removeTopRowBtn) removeTopRowBtn.addEventListener('click', () => {
        if (initialValues.length > 0) {
            initialValues.shift();
            positionValues.shift();
            generateRows();
        }
    });

    if(saveBtn) saveBtn.addEventListener('click', () => {
        const dataToSave = { initialValues, positionValues };
        const blob = new Blob([JSON.stringify(dataToSave)], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'calculadora_gc_datos.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });

    if(predefinedFileSelect) predefinedFileSelect.addEventListener('change', () => {
        const selected = predefinedFileSelect.value;
        if (selected && predefinedData[selected]) {
            initialValues = [...predefinedData[selected].initialValues];
            positionValues = [...predefinedData[selected].positionValues];
            generateRows();
        } else if (!selected) {
            initialValues = [...defaultInitialValues];
            positionValues = Array(defaultInitialValues.length).fill(14);
            generateRows();
        }
    });

    // Modo Oscuro
    const initializeTheme = () => {
        const stored = localStorage.getItem('theme');
        if (stored === 'dark') {
            html.setAttribute('data-mode', 'dark');
            toggleIcon.classList.replace('fa-moon', 'fa-sun');
        } else {
            html.setAttribute('data-mode', 'light');
            toggleIcon.classList.replace('fa-sun', 'fa-moon');
        }
    };

    if(darkModeToggle) darkModeToggle.addEventListener('click', () => {
        const current = html.getAttribute('data-mode');
        const next = current === 'dark' ? 'light' : 'dark';
        html.setAttribute('data-mode', next);
        localStorage.setItem('theme', next);
        if (next === 'dark') {
            toggleIcon.classList.replace('fa-moon', 'fa-sun');
        } else {
            toggleIcon.classList.replace('fa-sun', 'fa-moon');
        }
    });

    // Inicialización
    initializeTheme();
    generateRows(); // Llamada inicial para pintar la tabla
});
