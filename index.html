<!DOCTYPE html>
<html lang="es" data-mode="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calculadora GC - V5</title>
    
    <!-- Icono de la pestaña -->
    <link rel="icon" type="image/png" href="calculator_icon.png">

    <!-- Estilos Externos (Tailwind y FontAwesome) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- ESTILOS CSS (Diseño) -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        /* Variables de Color */
        :root {
            --primary: #3b82f6;
            --bg-light: #f9fafb;
            --surface-light: #ffffff;
            --border-light: #e5e7eb;
            --text-light: #374151;
            
            --bg-dark: #1f2937;
            --surface-dark: #374151;
            --border-dark: #4b5563;
            --text-dark: #e5e7eb;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-light);
            transition: background-color 0.3s, color 0.3s;
            padding-bottom: 80px; /* Espacio para scroll en móvil */
        }

        /* Tarjetas y Contenedores */
        .flat-card {
            background-color: var(--surface-light);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-light);
            transition: all 0.3s ease;
        }

        /* Botones */
        .flat-btn {
            border: none;
            border-radius: 8px;
            color: white;
            transition: transform 0.1s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .flat-btn:active { transform: scale(0.95); }

        .action-btn {
            width: 42px;
            height: 42px;
            font-size: 1.1rem;
        }

        /* Tabla */
        .table-header { background: var(--primary); color: white; }
        .table-row-hover:hover { background-color: #f3f4f6; }
        
        /* Inputs */
        .custom-input {
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background-color: #fff;
            color: #374151;
            transition: border-color 0.2s;
        }
        .custom-input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        /* Modo Oscuro */
        html[data-mode="dark"] body { background-color: var(--bg-dark); color: var(--text-dark); }
        html[data-mode="dark"] .flat-card { background-color: var(--surface-dark); border-color: var(--border-dark); }
        html[data-mode="dark"] .custom-input, 
        html[data-mode="dark"] select { background-color: #4b5563; border-color: #6b7280; color: white; }
        html[data-mode="dark"] .table-row-hover:hover { background-color: #4b5563; }
        html[data-mode="dark"] .action-container { border-top-color: #4b5563; background-color: #374151; }

        /* Colores de Ganancia */
        .profit-positive { color: #10b981; font-weight: 700; }
        .profit-negative { color: #ef4444; font-weight: 700; }
        html[data-mode="dark"] .profit-positive { color: #4ade80; }
        html[data-mode="dark"] .profit-negative { color: #f87171; }

        /* Botón Flotante (Luna/Sol) */
        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 50;
            background-color: var(--surface-light);
            color: var(--text-light);
            border: 1px solid var(--border-light);
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        html[data-mode="dark"] .fab { background-color: var(--surface-dark); color: var(--text-dark); border-color: var(--border-dark); }
        #toggleIcon.fa-sun { color: #fbbf24; }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4">

    <!-- Botón Modo Oscuro -->
    <button id="darkModeToggle" class="fab flat-btn p-4 text-xl" aria-label="Cambiar tema">
        <i class="fas fa-moon" id="toggleIcon"></i>
    </button>

    <!-- Título Visible en Móvil -->
    <h1 class="text-2xl font-bold mb-4 text-gray-700 dark:text-gray-200 md:hidden">Calculadora GC</h1>

    <!-- Tarjeta Principal -->
    <div class="flat-card w-full max-w-5xl overflow-hidden mb-20 md:mb-8">
        
        <!-- Tabla con Scroll Horizontal -->
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse whitespace-nowrap">
                <thead>
                    <tr class="table-header text-sm uppercase tracking-wider">
                        <th class="p-3 text-center">#</th>
                        <th class="p-3">Ent</th>
                        <th class="p-3">Valor</th>
                        <th class="p-3">Carga</th>
                        <th class="p-3">Inv</th>
                        <th class="p-3">Pago</th>
                        <th class="p-3">Ganancia</th>
                    </tr>
                </thead>
                <tbody id="resultsBody" class="text-sm">
                    <!-- Fila de Carga -->
                    <tr id="loadingRow">
                        <td colspan="7" class="p-10 text-center text-gray-500 dark:text-gray-400">
                            <i class="fas fa-circle-notch fa-spin text-3xl mb-2 text-blue-500"></i>
                            <br>Cargando aplicación...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Panel de Control (Botones) -->
        <div class="p-4 bg-gray-50 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 action-container">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                
                <!-- Selector y Guardar -->
                <div class="flex w-full md:w-auto gap-2">
                    <button id="saveBtn" class="flat-btn action-btn bg-emerald-500 hover:bg-emerald-600 flex-shrink-0">
                        <i class="fas fa-save"></i>
                    </button>
                    <div class="relative w-full">
                        <select id="predefinedFileSelect" class="w-full md:w-64 h-full pl-3 pr-8 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 text-sm appearance-none focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="">Seleccionar Archivo...</option>
                            <option value="08-13-0400K">400 K - 08 - 13</option>
                            <option value="08-13-0450K">450 K - 08 - 13</option>
                            <option value="08-13-0500K">500 K - 08 - 13</option>
                            <option value="08-14-0500K">500 K - 08 - 14</option>
                            <option value="08-14-0550K">550 K - 08 - 14</option>
                            <option value="08-14-0600K">600 K - 08 - 14</option>
                            <option value="09-13-0600K">600 K - 09 - 13</option>
                            <option value="09-13-0640K">640 K - 09 - 13</option>
                            <option value="09-13-0700K">700 K - 09 - 13</option>
                            <option value="09-14-0750K">750 K - 09 - 14</option>
                            <option value="09-14-0800K">800 K - 09 - 14</option>
                            <option value="09-14-0850K">850 K - 09 - 14</option>
                            <option value="09-14-0900K">900 K - 09 - 14</option>
                            <option value="09-14-0950K">950 K - 09 - 14</option>
                            <option value="09-14-1000M">1000 M - 09 - 14</option>
                            <option value="09-14-1050M">1050 M - 09 - 14</option>
                            <option value="10-13-1100M">1100 M - 10 - 13</option>
                            <option value="09-14-1200M">1200 M - 09 - 14</option>
                            <option value="10-14-1200M">1200 M - 10 - 14</option>
                            <option value="10-14-1250M">1250 M - 10 - 14</option>
                            <option value="10-14-1450M">1450 M - 10 - 14</option>
                            <option value="10-14-1750M">1750 M - 10 - 14</option>
                            <option value="10-14-1900M">1900 M - 10 - 14</option>
                            <option value="10-14-2000M">2000 M - 10 - 14</option>
                            <option value="11-13-2000M">2000 M - 11 - 13</option>
                            <option value="8000_400K_08_13">$8000 400K 08 13</option>
                            <option value="16000_700K_08_14">$16000 700K 08 14</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                            <i class="fas fa-chevron-down text-xs"></i>
                        </div>
                    </div>
                </div>

                <!-- Botones de Acción -->
                <div class="flex flex-wrap justify-center gap-3 w-full md:w-auto">
                    <button id="addRowBtn" class="flat-btn action-btn bg-blue-500 hover:bg-blue-600" title="Añadir Fila"><i class="fas fa-plus"></i></button>
                    <button id="addTopRowBtn" class="flat-btn action-btn bg-purple-500 hover:bg-purple-600" title="Añadir Arriba"><i class="fas fa-arrow-up"></i></button>
                    <div class="w-px h-10 bg-gray-300 dark:bg-gray-600 mx-1 hidden md:block"></div>
                    <button id="removeRowBtn" class="flat-btn action-btn bg-red-500 hover:bg-red-600" title="Borrar Fila"><i class="fas fa-trash"></i></button>
                    <button id="removeTopRowBtn" class="flat-btn action-btn bg-orange-500 hover:bg-orange-600" title="Borrar Arriba"><i class="fas fa-backspace"></i></button>
                    <button id="resetBtn" class="flat-btn action-btn bg-gray-500 hover:bg-gray-600 ml-auto md:ml-0" title="Reiniciar"><i class="fas fa-redo"></i></button>
                </div>

            </div>
        </div>
    </div>

    <!-- LÓGICA JAVASCRIPT (Script) -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Referencias
            const resultsBody = document.getElementById('resultsBody');
            const saveBtn = document.getElementById('saveBtn');
            const resetBtn = document.getElementById('resetBtn');
            const addRowBtn = document.getElementById('addRowBtn');
            const addTopRowBtn = document.getElementById('addTopRowBtn');
            const removeRowBtn = document.getElementById('removeRowBtn');
            const removeTopRowBtn = document.getElementById('removeTopRowBtn');
            const predefinedFileSelect = document.getElementById('predefinedFileSelect');
            const darkModeToggle = document.getElementById('darkModeToggle');
            const toggleIcon = document.getElementById('toggleIcon');
            const html = document.documentElement;

            // Datos Base
            const defaultInitialValues = [250,500,1000,2000,4000,7500,13000,22000,37000,61500];
            let initialValues = [...defaultInitialValues];
            let positionValues = Array(defaultInitialValues.length).fill(14);

            // Datos Predefinidos
            const predefinedData = {
                '08-13-0400K': { "initialValues": [250, 500, 1000, 1750, 3000, 4750, 7750, 12000], "positionValues": [12, 13, 13, 13, 13, 13, 13, 13] },
                '08-13-0450K': { "initialValues": [250, 500, 1000, 2000, 3250, 5250, 8750, 13750], "positionValues": [12, 13, 13, 13, 13, 13, 13, 13] },
                '08-13-0500K': { "initialValues": [250, 500, 1000, 2000, 3500, 6000, 9750, 15500], "positionValues": [12, 13, 13, 13, 13, 13, 13, 13] },
                '08-14-0500K': { "initialValues": [250, 500, 1000, 1750, 3000, 5250, 9000, 15000], "positionValues": [12, 14, 14, 14, 14, 14, 14, 14] },
                '08-14-0550K': { "initialValues": [250, 500, 1000, 2000, 3500, 6000, 9750, 16250], "positionValues": [12, 14, 14, 14, 14, 14, 14, 14] },
                '09-13-0600K': { "initialValues": [250, 500, 1000, 1750, 2750, 4500, 7000, 11000, 17500], "positionValues": [12, 13, 13, 13, 13, 13, 13, 13, 13] },
                '08-14-0600K': { "initialValues": [250, 500, 1000, 2000, 3750, 6500, 10750, 18000], "positionValues": [12, 14, 14, 14, 14, 14, 14, 14] },
                '09-13-0640K': { "initialValues": [250, 500, 1000, 1750, 2750, 4750, 7500, 12000, 18750], "positionValues": [12, 13, 13, 13, 13, 13, 13, 13, 13] },
                '09-13-0700K': { "initialValues": [250, 500, 1000, 2000, 3250, 5250, 8500, 13750, 21000], "positionValues": [12, 13, 13, 13, 13, 13, 13, 13, 12] },
                '09-14-0750K': { "initialValues": [250, 500, 1000, 1750, 3000, 5000, 8250, 13750, 21750], "positionValues": [12, 14, 14, 14, 14, 14, 14, 14, 13] },
                '09-14-0800K': { "initialValues": [250, 500, 1000, 1750, 3000, 5000, 8500, 14000, 23250], "positionValues": [12, 14, 14, 14, 14, 14, 14, 14, 14] },
                '09-14-0850K': { "initialValues": [250, 500, 1000, 1750, 3000, 5250, 9000, 15000, 25000], "positionValues": [12, 14, 14, 14, 14, 14, 14, 14, 14] },
                '09-14-0900K': { "initialValues": [250, 500, 1000, 2000, 3500, 5750, 9500, 15750, 26000], "positionValues": [12, 14, 14, 14, 14, 14, 14, 14, 14] },
                '09-14-0950K': { "initialValues": [250, 500, 1000, 2000, 3500, 6000, 10000, 16750, 28000], "positionValues": [12, 14, 14, 14, 14, 14, 14, 14, 14] },
                '09-14-1000M': { "initialValues": [250, 500, 1000, 2000, 3500, 6000, 10500, 17750, 30000], "positionValues": [12, 14, 14, 14, 14, 14, 14, 14, 14] },
                '09-14-1050M': { "initialValues": [250, 500, 1000, 2000, 3750, 6500, 11000, 18500, 31500], "positionValues": [12, 14, 14, 14, 14, 14, 14, 14, 14] },
                '10-13-1100M': { "initialValues": [250, 500, 1000, 1750, 3000, 5000, 8000, 13000, 20500, 32000], "positionValues": [12, 13, 13, 13, 13, 13, 13, 13, 13, 13] },
                '09-14-1200M': { "initialValues": [250, 500, 1000, 2000, 4000, 7250, 12500, 21750, 36500], "positionValues": [12, 14, 14, 14, 14, 14, 14, 14, 14] },
                '10-14-1200M': { "initialValues": [250, 500, 1000, 1750, 3000, 5000, 8250, 13750, 21750, 34250], "positionValues": [12, 14, 14, 14, 14, 14, 14, 14, 13, 13] },
                '10-14-1250M': { "initialValues": [250, 500, 1000, 1750, 2750, 4750, 8000, 13250, 21750, 35250], "positionValues": [12, 14, 14, 14, 14, 14, 14, 14, 14, 14] },
                '10-14-1450M': { "initialValues": [250, 500, 1000, 1750, 3000, 5250, 9000, 15500, 25500, 42000], "positionValues": [12, 14, 14, 14, 14, 14, 14, 14, 14, 14] },
                '10-14-1750M': { "initialValues": [250, 500, 1000, 2000, 3750, 6500, 11000, 18500, 30750, 50750], "positionValues": [12, 14, 14, 14, 14, 14, 14, 14, 14, 14] },
                '10-14-1900M': { "initialValues": [250, 500, 1000, 2000, 4000, 7000, 12000, 20000, 33500, 55500], "positionValues": [12, 14, 14, 14, 14, 14, 14, 14, 14, 14] },
                '10-14-2000M': { "initialValues": [250, 500, 1000, 2000, 4000, 7000, 12500, 21000, 35500, 59000], "positionValues": [12, 14, 14, 14, 14, 14, 14, 14, 14, 14] },
                '11-13-2000M': { "initialValues": [250, 500, 1000, 2000, 3500, 5500, 9000, 14500, 23000, 36500, 58000], "positionValues": [12, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13] },
                '8000_400K_08_13': { "initialValues": [250, 500, 1000, 1750, 3000, 4750, 7500, 11750], "positionValues": [32, 13, 13, 13, 13, 13, 13, 13] },
                '16000_700K_08_14': { "initialValues": [500, 750, 1500, 2500, 4250, 7250, 12250, 20500], "positionValues": [32, 12, 14, 14, 14, 14, 14, 14] },
            };

            const formatCurrency = (num) => {
                if (isNaN(num)) return '$0';
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(Math.round(num));
            };

            const calculateAndDisplay = () => {
                 const rows = Array.from(resultsBody.querySelectorAll('tr:not(#loadingRow):not(.empty-state)'));
                 let runningInvestment = 0;
                 
                 rows.forEach((row, index) => {
                     const posInput = row.querySelector('.position-input');
                     const valInput = row.querySelector('.initial-value-input');
                     
                     if (!posInput || !valInput) return;

                     const pos = parseInt(posInput.value) || 0;
                     const val = parseFloat(valInput.value) || 0;
                     
                     const charge = val * pos;
                     runningInvestment += charge;
                     
                     const payment = val * 36;
                     const profit = payment - runningInvestment;
                     
                     row.querySelector('.charge-cell').textContent = formatCurrency(charge);
                     row.querySelector('.investment-cell').textContent = formatCurrency(runningInvestment);
                     row.querySelector('.payment-cell').textContent = formatCurrency(payment);
                     
                     const profitCell = row.querySelector('.profit-cell');
                     profitCell.textContent = formatCurrency(profit);
                     profitCell.className = `p-3 profit-cell font-medium ${profit >= 0 ? 'profit-positive' : 'profit-negative'}`;
                 });
            };

            const generateRows = () => {
                let htmlContent = '';
                if (initialValues.length < 1) {
                    resultsBody.innerHTML = `<tr class="empty-state"><td colspan="7" class="p-6 text-center text-gray-500 dark:text-gray-400">No hay filas. Usa el botón azul para añadir.</td></tr>`;
                    return;
                }

                for (let i = 0; i < initialValues.length; i++) {
                    htmlContent += `
                        <tr class="table-row-hover text-sm border-b border-gray-100 dark:border-gray-700 transition-colors">
                            <td class="p-3 text-center text-gray-500 font-medium">${i + 1}</td>
                            <td class="p-3">
                                <input type="number" class="w-12 md:w-16 px-1 py-1 custom-input position-input text-center text-sm" value="${positionValues[i]}" min="1" max="36">
                            </td>
                            <td class="p-3">
                                <div class="relative flex items-center">
                                    <span class="absolute left-2 text-gray-400 text-xs">$</span>
                                    <input type="number" step="250" class="w-24 md:w-28 pl-5 pr-2 py-1 custom-input initial-value-input text-sm" value="${initialValues[i]}">
                                </div>
                            </td>
                            <td class="p-3 charge-cell font-medium"></td>
                            <td class="p-3 investment-cell text-gray-600 dark:text-gray-400"></td>
                            <td class="p-3 payment-cell font-medium text-blue-600 dark:text-blue-400"></td>
                            <td class="p-3 profit-cell"></td>
                        </tr>
                    `;
                }
                resultsBody.innerHTML = htmlContent;
                calculateAndDisplay();
            };

            // Listeners
            resultsBody.addEventListener('input', (e) => {
                if (e.target.classList.contains('position-input') || e.target.classList.contains('initial-value-input')) {
                     const rows = Array.from(resultsBody.querySelectorAll('tr:not(#loadingRow):not(.empty-state)'));
                     const row = e.target.closest('tr');
                     const index = rows.indexOf(row);
                     
                     if(index > -1) {
                         if(e.target.classList.contains('position-input')) positionValues[index] = parseInt(e.target.value) || 0;
                         if(e.target.classList.contains('initial-value-input')) initialValues[index] = parseFloat(e.target.value) || 0;
                     }
                     calculateAndDisplay();
                }
            });

            addRowBtn.addEventListener('click', () => {
                const lastVal = initialValues.length > 0 ? initialValues[initialValues.length - 1] : defaultInitialValues[0];
                initialValues.push(lastVal * 2);
                positionValues.push(14);
                generateRows();
            });

            addTopRowBtn.addEventListener('click', () => {
                const firstVal = initialValues.length > 0 ? initialValues[0] : defaultInitialValues[0];
                initialValues.unshift(Math.max(50, Math.round(firstVal / 2)));
                positionValues.unshift(14);
                generateRows();
            });

            removeRowBtn.addEventListener('click', () => {
                if (initialValues.length > 0) { initialValues.pop(); positionValues.pop(); generateRows(); }
            });

            removeTopRowBtn.addEventListener('click', () => {
                if (initialValues.length > 0) { initialValues.shift(); positionValues.shift(); generateRows(); }
            });

            resetBtn.addEventListener('click', () => {
                initialValues = [...defaultInitialValues];
                positionValues = Array(defaultInitialValues.length).fill(14);
                generateRows();
            });

            saveBtn.addEventListener('click', () => {
                const dataToSave = { initialValues, positionValues };
                const blob = new Blob([JSON.stringify(dataToSave)], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'calculadora_gc_datos.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });

            predefinedFileSelect.addEventListener('change', () => {
                const selected = predefinedFileSelect.value;
                if (selected && predefinedData[selected]) {
                    initialValues = [...predefinedData[selected].initialValues];
                    positionValues = [...predefinedData[selected].positionValues];
                    generateRows();
                } else if (!selected) {
                    initialValues = [...defaultInitialValues];
                    positionValues = Array(defaultInitialValues.length).fill(14);
                    generateRows();
                }
            });

            // Tema
            const initTheme = () => {
                const stored = localStorage.getItem('theme') || 'light';
                html.setAttribute('data-mode', stored);
                toggleIcon.className = stored === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            };
            
            darkModeToggle.addEventListener('click', () => {
                const current = html.getAttribute('data-mode');
                const next = current === 'dark' ? 'light' : 'dark';
                html.setAttribute('data-mode', next);
                localStorage.setItem('theme', next);
                toggleIcon.className = next === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            });

            // Iniciar
            initTheme();
            generateRows();
        });
    </script>
</body>
</html>
